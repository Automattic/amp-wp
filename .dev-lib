#!/bin/bash

DEFAULT_BASE_BRANCH=develop
ASSETS_DIR=wp-assets
PROJECT_SLUG=amp
README_MD_TITLE="AMP Plugin for WordPress"
DEV_LIB_SKIP="$DEV_LIB_SKIP,jshint"
CHECK_SCOPE=all

function after_wp_install {
	for i in {1..10}
	do
		curl --request GET --url https://amp-wp.org/wp-content/plugin-test-files/google.svg --header 'accept: image/webp,image/*,*/*;q=0.8' --header 'accept-charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7' --header 'accept-encoding: deflate, gzip' --header 'accept-language: en-us,en;q=0.5' --header 'cache-control: max-age=0' --header 'connection: keep-alive' --header 'host: amp-wp.org' --header 'keep-alive: 300' --header 'user-agent: amp-wp, v1.5.0-alpha, http://example.org' -o file
	done

	if [[ "$WP_VERSION" != "4.9" ]]; then
		echo -n "Installing Gutenberg..."
		gutenberg_plugin_svn_url=https://plugins.svn.wordpress.org/gutenberg/trunk/
		svn export -q "$gutenberg_plugin_svn_url" "$WP_CORE_DIR/src/wp-content/plugins/gutenberg"

		if [ ! -s "$WP_CORE_DIR/src/wp-includes/css/dist/block-library/style.css" ]; then
			svn export -q --force https://plugins.svn.wordpress.org/gutenberg/trunk/build/block-library/ "$WP_CORE_DIR/src/wp-includes/css/dist/block-library"
		fi

		echo "done"
	fi

	if [[ ! -z $INSTALL_PWA_PLUGIN ]]; then
		echo -n "Installing PWA 0.2-alpha2..."
		wget -O "$WP_CORE_DIR/src/wp-content/plugins/pwa.zip" https://github.com/xwp/pwa-wp/releases/download/0.2-alpha2/pwa.zip
		unzip -d "$WP_CORE_DIR/src/wp-content/plugins/pwa/" "$WP_CORE_DIR/src/wp-content/plugins/pwa.zip"
		echo "done"
	fi
}

function coverage_clover {
	if [[ ! -z $RUN_PHPUNIT_COVERAGE ]]; then
		echo --coverage-clover build/logs/clover.xml
	fi
}
